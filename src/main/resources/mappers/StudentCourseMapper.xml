<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.mapper.StudentCourseMapper">

    <resultMap id="StudentCourseResultMap" type="StudentCourse">
        <id property="id" column="id"/>
        <result property="studentId" column="student_id"/>
        <result property="courseId" column="course_id"/>
        <result property="enrollmentDate" column="enrollment_date"/>
        <result property="grade" column="grade"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <resultMap id="StudentCourseWithStudentResultMap" type="StudentCourse" extends="StudentCourseResultMap">
        <association property="student" javaType="Student">
            <id property="id" column="student_id"/>
            <result property="name" column="student_name"/>
            <result property="email" column="student_email"/>
            <result property="phone" column="student_phone"/>
            <result property="departmentId" column="department_id"/>
        </association>
    </resultMap>

    <resultMap id="StudentCourseWithCourseResultMap" type="StudentCourse" extends="StudentCourseResultMap">
        <association property="course" javaType="Course">
            <id property="id" column="course_id"/>
            <result property="name" column="course_name"/>
            <result property="code" column="course_code"/>
            <result property="credits" column="course_credits"/>
            <result property="description" column="course_description"/>
        </association>
    </resultMap>

    <select id="findAll" resultMap="StudentCourseResultMap">
        SELECT id, student_id, course_id, enrollment_date, grade, created_at
        FROM student_course
        ORDER BY enrollment_date DESC
    </select>

    <select id="findById" resultMap="StudentCourseResultMap">
        SELECT id, student_id, course_id, enrollment_date, grade, created_at
        FROM student_course
        WHERE id = #{id}
    </select>

    <select id="findByStudentAndCourse" resultMap="StudentCourseResultMap">
        SELECT id, student_id, course_id, enrollment_date, grade, created_at
        FROM student_course
        WHERE student_id = #{studentId} AND course_id = #{courseId}
    </select>

    <select id="findByStudentId" resultMap="StudentCourseResultMap">
        SELECT id, student_id, course_id, enrollment_date, grade, created_at
        FROM student_course
        WHERE student_id = #{studentId}
        ORDER BY enrollment_date DESC
    </select>

    <select id="findByCourseId" resultMap="StudentCourseResultMap">
        SELECT id, student_id, course_id, enrollment_date, grade, created_at
        FROM student_course
        WHERE course_id = #{courseId}
        ORDER BY enrollment_date DESC
    </select>

    <select id="findByStudentIdWithCourse" resultMap="StudentCourseWithCourseResultMap">
        SELECT 
            sc.id, sc.student_id, sc.course_id, sc.enrollment_date, sc.grade, sc.created_at,
            c.name as course_name, c.code as course_code, c.credits as course_credits,
            c.description as course_description
        FROM student_course sc
        INNER JOIN course c ON sc.course_id = c.id
        WHERE sc.student_id = #{studentId}
        ORDER BY sc.enrollment_date DESC
    </select>

    <select id="findByCourseIdWithStudent" resultMap="StudentCourseWithStudentResultMap">
        SELECT 
            sc.id, sc.student_id, sc.course_id, sc.enrollment_date, sc.grade, sc.created_at,
            s.name as student_name, s.email as student_email, s.phone as student_phone,
            s.department_id
        FROM student_course sc
        INNER JOIN student s ON sc.student_id = s.id
        WHERE sc.course_id = #{courseId}
        ORDER BY s.name
    </select>

    <insert id="insert" parameterType="StudentCourse" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO student_course (student_id, course_id, enrollment_date, grade, created_at)
        VALUES (#{studentId}, #{courseId}, #{enrollmentDate}, #{grade}, CURRENT_TIMESTAMP)
    </insert>

    <update id="update" parameterType="StudentCourse">
        UPDATE student_course 
        SET enrollment_date = #{enrollmentDate}, 
            grade = #{grade}
        WHERE id = #{id}
    </update>

    <delete id="deleteById">
        DELETE FROM student_course WHERE id = #{id}
    </delete>

    <delete id="deleteByStudentAndCourse">
        DELETE FROM student_course 
        WHERE student_id = #{studentId} AND course_id = #{courseId}
    </delete>

</mapper>